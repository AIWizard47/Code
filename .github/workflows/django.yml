name: Django CI & Auto Deploy

on:
  push:
    branches: [ "main/project_maker" ]
  pull_request:
    branches: [ "main/project_maker" ]

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        python-version: [3.11]

    steps:

    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Apply migrations
      run: |
        python manage.py makemigrations
        python manage.py migrate

    - name: Run tests
      run: |
        python manage.py test --verbosity=2

    - name: Collect static files
      run: |
        python manage.py collectstatic --noinput



    ##############################################
    #          DEPLOYMENT TO YOUR SERVER         #
    ##############################################

    - name: Zip project (code-main.zip)
      run: |
        zip -r code-main.zip ./

    - name: Upload ZIP to server (/home/Beta01/)
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.REMOTE_HOST }}
        username: ${{ secrets.REMOTE_USER }}
        port: ${{ secrets.REMOTE_PORT }}
        key: ${{ secrets.REMOTE_SSH_KEY }}
        source: "code-main.zip"
        target: "/home/Beta01/"

    - name: Extract and Deploy on server
      uses: appleboy/ssh-action@v1.2.0
      with:
        host: ${{ secrets.REMOTE_HOST }}
        username: ${{ secrets.REMOTE_USER }}
        port: ${{ secrets.REMOTE_PORT }}
        key: ${{ secrets.REMOTE_SSH_KEY }}
        script: |
          cd /home/Beta01/

          # Remove previous extracted code folder
          rm -rf code-main/

          # Extract the uploaded zip
          unzip -o code-main.zip -d code-main/

          # (Optional) Install requirements if needed
          cd code-main/
          # source venv/bin/activate
          pip install -r requirements.txt

          # Restart your Django service
          # sudo systemctl restart <YOUR_SERVICE_NAME>
