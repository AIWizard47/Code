<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Let'sCode - {{ problem.title }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * {
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1e1e1e;
        }
        ::-webkit-scrollbar-thumb {
            background: #4a4a4a;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #666;
        }

        .main-container {
            display: flex;
            height: 100vh;
            width: 100vw;
            background: #0d1117;
            overflow: hidden;
        }

        .left-panel {
            flex: 0 0 50%;
            min-width: 300px;
            background: #161b22;
            color: #c9d1d9;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #30363d;
            overflow: hidden;
        }

        .right-panel {
            flex: 0 0 50%;
            min-width: 300px;
            background: #0d1117;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            padding: 14px 18px;
            background: #161b22;
            border-bottom: 1px solid #30363d;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }

        .tabs {
            display: flex;
            gap: 4px;
            padding: 0 18px;
            background: #161b22;
            border-bottom: 1px solid #30363d;
            flex-shrink: 0;
        }

        .tab {
            padding: 12px 18px;
            color: #8b949e;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 14px;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .tab:hover {
            color: #c9d1d9;
        }

        .tab.active {
            color: #58a6ff;
            border-bottom-color: #58a6ff;
        }

        .content {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            min-height: 0;
        }

        .problem-title {
            font-size: 22px;
            font-weight: 600;
            color: #c9d1d9;
            margin-bottom: 14px;
        }

        .difficulty {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 5px;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 18px;
        }

        .difficulty-easy { background: #1a7f3722; color: #3fb950; }
        .difficulty-medium { background: #d2920322; color: #d29922; }
        .difficulty-hard { background: #f8514922; color: #f85149; }

        .section {
            margin-bottom: 24px;
        }

        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: #8b949e;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .section-content {
            color: #c9d1d9;
            line-height: 1.7;
            font-size: 15px;
        }

        .code-block {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 14px;
            margin-top: 10px;
            overflow-x: auto;
            font-size: 14px;
            font-family: 'Consolas', 'Monaco', monospace;
            white-space: pre-wrap;
            word-break: break-word;
        }

        #editor {
            flex: 1;
            min-height: 0;
            width: 100%;
        }

        .editor-controls {
            padding: 12px 18px;
            background: #161b22;
            border-bottom: 1px solid #30363d;
            display: flex;
            gap: 12px;
            align-items: center;
            flex-shrink: 0;
        }

        .language-select {
            background: #21262d;
            border: 1px solid #30363d;
            color: #c9d1d9;
            padding: 8px 14px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            outline: none;
        }

        .language-select:focus {
            border-color: #58a6ff;
        }

        .btn {
            padding: 8px 18px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 7px;
        }

        .btn-run {
            background: #21262d;
            color: #c9d1d9;
            border: 1px solid #30363d;
        }

        .btn-run:hover:not(:disabled) {
            background: #30363d;
        }

        .btn-submit {
            background: #238636;
            color: white;
        }

        .btn-submit:hover:not(:disabled) {
            background: #2ea043;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .console {
            background: #161b22;
            border-top: 1px solid #30363d;
            padding: 18px;
            overflow-y: auto;
            max-height: 250px;
            flex-shrink: 0;
        }

        .console-title {
            font-size: 12px;
            font-weight: 600;
            color: #8b949e;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .output {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 14px;
            font-size: 14px;
            min-height: 70px;
            margin-bottom: 14px;
            white-space: pre-wrap;
            word-break: break-word;
            font-family: 'Consolas', 'Monaco', monospace;
            color: #c9d1d9;
        }

        .output:empty::before {
            content: 'No output';
            color: #6e7681;
        }

        .output.success {
            border-color: #2ea043;
            color: #3fb950;
        }

        .output.error {
            border-color: #f85149;
            color: #f85149;
        }

        .resize-handle {
            width: 5px;
            background: #21262d;
            cursor: ew-resize;
            transition: background 0.2s;
            flex-shrink: 0;
            user-select: none;
        }

        .resize-handle:hover {
            background: #58a6ff;
        }

        .spinner {
            display: inline-block;
            width: 13px;
            height: 13px;
            border: 2px solid #30363d;
            border-top-color: #58a6ff;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .nav-link {
            color: #58a6ff;
            text-decoration: none;
            font-size: 14px;
            transition: color 0.2s;
        }

        .nav-link:hover {
            color: #79c0ff;
        }

        .submission-card {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 14px;
            margin-bottom: 12px;
            font-size: 14px;
        }

        .submission-card strong {
            color: #8b949e;
        }

        .verdict-accepted { color: #3fb950; }
        .verdict-wrong { color: #f85149; }
        .verdict-other { color: #d29922; }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Left Panel -->
        <div id="leftPanel" class="left-panel">
            <div class="header">
                <div style="font-weight: 600; font-size: 15px;">Let'sCode</div>
                <div style="display: flex; gap: 18px;">
                    <a href="/problems/" class="nav-link">Problems</a>
                    {% if user.is_authenticated %}
                        <a href="/submissions/history/" class="nav-link">Submissions</a>
                        <a href="/problems/logout/" class="nav-link">Logout</a>
                    {% else %}
                        <a href="/accounts/login/" class="nav-link">Login</a>
                        <a href="/account/registrations/" class="nav-link">SignUp</a>
                    {% endif %}
                </div>
            </div>

            <div class="tabs">
                <button class="tab active" data-tab="problem">Problem</button>
                <button class="tab" data-tab="editorial">Editorial</button>
                <button class="tab" data-tab="solutions">Solutions</button>
                <button class="tab" data-tab="submissions">Submissions</button>
            </div>

            <div id="problem-content" class="content">
                <div class="problem-title">{{ problem.title }}</div>
                <span class="difficulty difficulty-{{ problem.difficulty|lower }}">{{ problem.difficulty }}</span>

                <div class="section">
                    <p class="section-content">{{ problem.description }}</p>
                </div>

                <div class="section">
                    <div class="section-title">Input</div>
                    <div class="section-content">{{ problem.input_description }}</div>
                </div>

                <div class="section">
                    <div class="section-title">Output</div>
                    <div class="section-content">{{ problem.output_description }}</div>
                </div>


                <div class="section">
                    <div class="section-title">Sample Input</div>
                    <div class="code-block">{{ problem.sample_input }}</div>
                </div>

                <div class="section">
                    <div class="section-title">Sample Output</div>
                    <div class="code-block">{{ problem.sample_output }}</div>
                </div>
                <div class="section">
                    <div class="section-title">Constraints</div>
                    <div class="section-content">{{ problem.constraints|linebreaks }}</div>
                </div>
            </div>

            <div id="editorial-content" class="content" style="display: none;">
                <div class="problem-title">Editorial</div>
                <p class="section-content">Editorial content coming soon...</p>
            </div>

            <div id="solutions-content" class="content" style="display: none;">
                <div class="problem-title">Solutions</div>
                <p class="section-content" style="margin-bottom: 16px;">Community solutions and approaches:</p>
                {% if problem_code %}
                    <div class="section">
                        <div class="section-title">Sample Solution</div>
                        <div class="code-block">{{ problem_code }}</div>
                    </div>
                {% else %}
                    <p class="section-content">No solutions available yet.</p>
                {% endif %}
            </div>

            <div id="submissions-content" class="content" style="display: none;">
                <div class="problem-title">Your Submissions</div>
                {% for sub in submission_history %}
                    <div class="submission-card">
                        <p><strong>Time:</strong> {{ sub.created_at|date:"M d, Y H:i" }}</p>
                        <p><strong>Language:</strong> {{ sub.language|title }}</p>
                        <p>
                            <strong>Verdict:</strong> 
                            <span class="
                                {% if sub.verdict == 'Accepted' %}verdict-accepted
                                {% elif sub.verdict in 'Wrong Answer,Time Limit Exceeded,Memory Limit Exceeded,Runtime Error' %}verdict-wrong
                                {% else %}verdict-other
                                {% endif %}
                            ">{{ sub.verdict }}</span>
                        </p>
                        <p><strong>Runtime:</strong> {{ sub.runtime|default:"N/A" }} ms</p>
                    </div>
                {% empty %}
                    <p class="section-content">No submissions yet.</p>
                {% endfor %}

                {% if submission_history.has_other_pages %}
                <div style="display: flex; justify-content: center; gap: 10px; margin-top: 18px;">
                    {% if submission_history.has_previous %}
                    <a href="?page={{ submission_history.previous_page_number }}" class="nav-link">Previous</a>
                    {% endif %}
                    <span style="color: #8b949e; font-size: 14px;">Page {{ submission_history.number }} of {{ submission_history.paginator.num_pages }}</span>
                    {% if submission_history.has_next %}
                    <a href="?page={{ submission_history.next_page_number }}" class="nav-link">Next</a>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>

        <div id="resizer" class="resize-handle"></div>

        <!-- Right Panel -->
        <div id="rightPanel" class="right-panel">
            <div class="editor-controls">
                <select id="language" class="language-select">
                    <option value="python" {% if selected_language == "python" %}selected{% endif %}>Python3</option>
                    <option value="cpp" {% if selected_language == "cpp" %}selected{% endif %}>C++</option>
                    <option value="java" {% if selected_language == "java" %}selected{% endif %}>Java</option>
                </select>
                <div style="flex: 1"></div>
                <button class="btn btn-run" id="runButton" onclick="runCode()">
                    <span id="runText">Run</span>
                </button>
                <button class="btn btn-submit" id="submitButton" onclick="submitCode()">
                    <span id="submitText">Submit</span>
                </button>
            </div>

            <div id="editor"></div>

            <div class="console">
                <div class="console-title">Output</div>
                <div id="output" class="output"></div>
                <div class="console-title">Errors</div>
                <div id="errors" class="output"></div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>
    <script>
        let editor;
        const isUserAuthenticated = {% if user.is_authenticated %}true{% else %}false{% endif %};
        const problemId = '{{ problem.id }}';
        const csrfToken = '{{ csrf_token }}';

        const defaultCode = {
            python: `class Solution:
    def solve(self):
        # Write your solution here
        pass`,
            cpp: `#include <iostream>
using namespace std;

class Solution {
public:
    void solve() {
        // Write your solution here
    }
    main() {
        Solution obj;
        obj.solve();
        return 0;
    }
};`,
            java: `class Main {
    public void solve() {
        // Write your solution here
    }
    public static void main(String[] args) {
        Main obj = new Main();
        obj.solve();
    }
}`
        };

        require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs' } });

        window.onload = function() {
            require(['vs/editor/editor.main'], function() {
                const initialLanguage = document.getElementById('language').value;
                const lastSubmissionCode = `{% if last_submission %}{{ last_submission.code|escapejs }}{% endif %}`;

                editor = monaco.editor.create(document.getElementById('editor'), {
                    value: lastSubmissionCode || defaultCode[initialLanguage],
                    language: initialLanguage,
                    theme: 'vs-dark',
                    automaticLayout: true,
                    fontSize: 15,
                    minimap: { enabled: false },
                    scrollBeyondLastLine: false,
                    lineNumbers: 'on',
                    renderWhitespace: 'selection',
                    tabSize: 4,
                    wordWrap: 'on'
                });

                // Language change handler
                document.getElementById('language').addEventListener('change', function(e) {
                    const lang = e.target.value;
                    monaco.editor.setModelLanguage(editor.getModel(), lang);
                    
                    const storageKey = `problem_${problemId}_${lang}`;
                    const savedCode = localStorage.getItem(storageKey);
                    
                    if (savedCode) {
                        editor.setValue(savedCode);
                    } else {
                        editor.setValue(defaultCode[lang]);
                    }
                });

                // Auto-save to localStorage
                const autoSave = () => {
                    const lang = document.getElementById('language').value;
                    const storageKey = `problem_${problemId}_${lang}`;
                    localStorage.setItem(storageKey, editor.getValue());
                };
                setInterval(autoSave, 5000);
            });

            // Tab switching
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    const tabName = this.dataset.tab;
                    document.getElementById('problem-content').style.display = tabName === 'problem' ? 'block' : 'none';
                    document.getElementById('editorial-content').style.display = tabName === 'editorial' ? 'block' : 'none';
                    document.getElementById('solutions-content').style.display = tabName === 'solutions' ? 'block' : 'none';
                    document.getElementById('submissions-content').style.display = tabName === 'submissions' ? 'block' : 'none';
                });
            });

            // Resizing
            const leftPanel = document.getElementById('leftPanel');
            const rightPanel = document.getElementById('rightPanel');
            const resizer = document.getElementById('resizer');
            let isResizing = false;

            resizer.addEventListener('mousedown', (e) => {
                isResizing = true;
                e.preventDefault();
            });

            document.addEventListener('mousemove', (e) => {
                if (!isResizing) return;
                
                const container = document.querySelector('.main-container');
                const containerRect = container.getBoundingClientRect();
                const leftWidth = ((e.clientX - containerRect.left) / containerRect.width) * 100;
                
                if (leftWidth > 25 && leftWidth < 75) {
                    leftPanel.style.flex = `0 0 ${leftWidth}%`;
                    rightPanel.style.flex = `0 0 ${100 - leftWidth}%`;
                }
            });

            document.addEventListener('mouseup', () => {
                isResizing = false;
            });
        };

        async function runCode() {
            if (!isUserAuthenticated) {
                alert('Please login to run code');
                return;
            }

            const code = editor.getValue();
            const language = document.getElementById('language').value;
            const output = document.getElementById('output');
            const errors = document.getElementById('errors');
            const runButton = document.getElementById('runButton');
            const runText = document.getElementById('runText');
            
            runText.innerHTML = '<span class="spinner"></span> Running...';
            runButton.disabled = true;
            output.textContent = '';
            errors.textContent = '';
            output.classList.remove('success', 'error');

            try {
                const response = await fetch('/submissions/run/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': csrfToken
                    },
                    body: new URLSearchParams({
                        'problem_id': problemId,
                        'code': code,
                        'language': language
                    })
                });

                const data = await response.json();
                
                if (data.verdict === 'Accepted') {
                    output.classList.add('success');
                    output.textContent = `✓ ${data.verdict}\n\n${data.output || ''}`;
                } else {
                    output.classList.add('error');
                    output.textContent = `✗ ${data.verdict}\n\n${data.output || ''}`;
                }
                
                errors.textContent = data.error || '';
            } catch (error) {
                output.classList.add('error');
                output.textContent = 'Connection error. Please try again.';
                console.error('Error:', error);
            } finally {
                runText.textContent = 'Run';
                runButton.disabled = false;
            }
        }

        async function submitCode() {
            if (!isUserAuthenticated) {
                alert('Please login to submit code');
                return;
            }

            const code = editor.getValue();
            const language = document.getElementById('language').value;
            const output = document.getElementById('output');
            const errors = document.getElementById('errors');
            const submitButton = document.getElementById('submitButton');
            const submitText = document.getElementById('submitText');
            
            submitText.innerHTML = '<span class="spinner"></span> Submitting...';
            submitButton.disabled = true;
            output.textContent = '';
            errors.textContent = '';
            output.classList.remove('success', 'error');

            try {
                const response = await fetch('/submissions/submit/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': csrfToken
                    },
                    body: new URLSearchParams({
                        'problem_id': problemId,
                        'code': code,
                        'language': language
                    })
                });

                const data = await response.json();
                
                if (data.verdict === 'Accepted') {
                    output.classList.add('success');
                    const storageKey = `problem_${problemId}_${language}`;
                    localStorage.removeItem(storageKey);
                } else {
                    output.classList.add('error');
                }
                
                let resultText = `${data.verdict}\n\n`;
                if (data.test_results) {
                    data.test_results.forEach(tr => {
                        resultText += `Test ${tr.test_case}: ${tr.status}\n`;
                        if (tr.status === 'Failed') {
                            resultText += `Expected: ${tr.expected}\nActual: ${tr.actual}\n\n`;
                        }
                    });
                }
                output.textContent = resultText;
                errors.textContent = data.error || '';
            } catch (error) {
                output.classList.add('error');
                output.textContent = 'Connection error. Please try again.';
                console.error('Error:', error);
            } finally {
                submitText.textContent = 'Submit';
                submitButton.disabled = false;
            }
        }
    </script>
</body>
</html>